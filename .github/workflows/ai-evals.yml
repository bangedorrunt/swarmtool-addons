name: AI Evaluation & Testing

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-eval:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: 'latest'
          cache: 'bun'

      - name: Install dependencies
        run: bun install --frozen-lockfile

      # 1. Cháº¡y Unit Tests trÆ°á»›c (Nhanh vÃ  khÃ´ng tá»‘n phÃ­)
      - name: Run Unit Tests
        run: bun test

      # 2. KhÃ´i phá»¥c Cache cá»§a Evalite (Tiáº¿t kiá»‡m token)
      - name: Restore Evalite Cache
        uses: actions/cache@v4
        with:
          path: .evalite/cache
          key: ${{ runner.os }}-evalite-${{ hashFiles('**/SKILL.md', 'bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-evalite-

      # 3. Cháº¡y LLM Evaluations
      - name: Run AI Evaluations
        env:
          GOOGLE_GENERATIVE_AI_API_KEY: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
        run: bunx vitest run --config vitest.config.ts src/evals
        if: success()

      # 4. Táº¡o BÃ¡o cÃ¡o Tá»•ng há»£p (Step Summary)
      - name: Generate Evaluation Report
        if: always()
        run: |
          echo "### ðŸ“Š AI Evaluation Summary" >> $GITHUB_STEP_SUMMARY
          if [ -f "test-results.json" ]; then
            PASSED=$(jq '.numPassedTests' test-results.json)
            FAILED=$(jq '.numFailedTests' test-results.json)
            TOTAL=$(jq '.numTotalTests' test-results.json)
            DURATION=$(jq '.startTime' test-results.json)
            
            echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸš€ Total | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### ðŸ“ Detailed Results" >> $GITHUB_STEP_SUMMARY
            echo "| Test Suite | Status | Duration |" >> $GITHUB_STEP_SUMMARY
            echo "| :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
            jq -r '.testResults[] | "| \(.name) | \(.status) | \((.endTime - .startTime)/1000)s |"' test-results.json >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No evaluation results found." >> $GITHUB_STEP_SUMMARY
          fi

      # 5. LÆ°u láº¡i Cache má»›i
