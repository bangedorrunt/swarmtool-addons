# Project Setup

Initialize an OpenCode plugin project in under 5 minutes. This guide covers the foundational setup you need before writing any plugin code.

## Prerequisites

- **Node.js** 18+ or **Bun** (recommended for faster builds)
- A git repository
- Basic TypeScript knowledge

## Step 1: Initialize Project

Create a new directory and initialize it as an npm package:

```bash
mkdir my-opencode-plugin
cd my-opencode-plugin
bun init -y
```

## Step 2: Configure package.json

Your `package.json` needs specific configuration to work as an OpenCode plugin:

```json
{
  "name": "my-opencode-plugin",
  "version": "0.1.0",
  "description": "My first OpenCode plugin for skill injection",
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    },
    "./plugin": {
      "import": "./dist/plugin.js",
      "types": "./dist/plugin.d.ts"
    }
  },
  "scripts": {
    "build": "bun build ./src/index.ts --outfile ./dist/index.js --target node && bun build ./src/plugin.ts --outfile ./dist/plugin.js --target node && tsc",
    "dev": "bun --watch src/plugin.ts",
    "test": "bun test",
    "typecheck": "tsc --noEmit"
  },
  "peerDependencies": {
    "@opencode-ai/plugin": "^1.0.0"
  },
  "devDependencies": {
    "@opencode-ai/plugin": "^1.0.200",
    "@types/bun": "latest",
    "typescript": "^5.7.0"
  }
}
```

### Key Configuration Explained

| Field | Purpose |
|-------|---------|
| `type: "module"` | Required for ESM support |
| `main` | Entry point for programmatic imports |
| `exports` | Required for plugin loading (OpenCode imports via `./plugin`) |
| `exports["./plugin"]` | **Critical** - OpenCode loads plugins from this entry |
| `peerDependencies` | Declares that you work with OpenCode (not include it) |
| `build` script | Builds TypeScript → JavaScript with type definitions |

## Step 3: Create Directory Structure

```
my-opencode-plugin/
├── src/
│   ├── plugin.ts       # Plugin entry point (required)
│   └── index.ts       # Public API exports (optional)
├── dist/              # Generated by build (don't edit)
├── package.json
├── tsconfig.json
└── README.md
```

### Create directories:

```bash
mkdir -p src
```

## Step 4: Configure TypeScript

Create `tsconfig.json` for type checking:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "declaration": true,
    "declarationMap": true,
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "allowSyntheticDefaultImports": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

### Compiler Options Explained

| Option | Purpose |
|---------|---------|
| `declaration: true` | Generate `.d.ts` type definitions |
| `declarationMap: true` | Source maps for type definitions |
| `strict: true` | Catch errors at compile time |
| `moduleResolution: "bundler"` | Modern module resolution for Bun |

## Step 5: Create Minimal Plugin

Create `src/plugin.ts`:

```typescript
import { tool } from "@opencode-ai/plugin";

/**
 * Define a simple tool
 *
 * OpenCode's tool API uses Zod for argument validation.
 * Tools receive typed args and a ToolContext (sessionID, agent, abort signal).
 */
const helloWorld = tool({
  description: "Say hello to someone",
  args: {
    name: {
      type: tool.schema.string(),
      description: "Name of the person to greet",
    },
  },
  execute: async (args, context) => {
    return `Hello, ${args.name}!`;
  },
});

/**
 * OpenCode Plugin Entry Point
 *
 * CRITICAL: Only export the plugin function from this file.
 * OpenCode's plugin loader calls all exports as functions during initialization.
 * Exporting classes, constants, or non-function values will cause loading errors.
 */
export default async function myPlugin() {
  return {
    tool: {
      helloWorld,
    },
  };
}
```

Create `src/index.ts` for public API exports:

```typescript
/**
 * Public API for programmatic usage
 *
 * External code can import from here, but OpenCode loads from `./plugin`.
 */
export { helloWorld } from "./plugin";
```

## Step 6: Build and Test

Install dependencies:

```bash
bun install
```

Build the project:

```bash
bun run build
```

Verify the output:

```bash
ls -la dist/
# Should see: index.js, index.d.ts, plugin.js, plugin.d.ts
```

Run typecheck:

```bash
bun run typecheck
```

## Step 7: Test Locally (Optional)

For quick testing during development, you can link your plugin:

```bash
# In your plugin directory
bun link

# In your OpenCode project
bun link my-opencode-plugin

# Add to opencode.json
{
  "plugins": ["my-opencode-plugin"]
}
```

**Note:** For publishing, use the official npm workflow (covered in next guide).

## Common Mistakes

### ❌ Wrong: Missing `./plugin` export

```json
// package.json
"exports": {
  ".": { "import": "./dist/index.js" }  // Only main export
}
```

**Fix:** OpenCode requires `./plugin` export for plugin loading.

```json
"exports": {
  ".": { "import": "./dist/index.js" },
  "./plugin": { "import": "./dist/plugin.js" }  // Required!
}
```

### ❌ Wrong: Exporting non-functions from plugin.ts

```typescript
// plugin.ts
export const VERSION = "1.0.0";  // ❌ Breaks plugin loading
export class Helper {}  // ❌ Breaks plugin loading
export default myPlugin;  // ✅ Only this works
```

**Rule:** Plugin entry point (`src/plugin.ts`) must export **only functions**.

### ❌ Wrong: Using dependencies instead of peerDependencies

```json
"dependencies": {
  "@opencode-ai/plugin": "^1.0.0"  // ❌ Causes version conflicts
}
```

**Fix:** Use `peerDependencies` to let OpenCode manage the version.

```json
"peerDependencies": {
  "@opencode-ai/plugin": "^1.0.0"  // ✅ Correct
}
```

### ❌ Wrong: Missing build step in package.json

```json
"scripts": {
  // No build script
}
```

**Fix:** Build script is required for deployment.

```json
"scripts": {
  "build": "bun build ./src/index.ts --outfile ./dist/index.js --target node && bun build ./src/plugin.ts --outfile ./dist/plugin.js --target node && tsc"
}
```

## What's Next

- **[02-skill-injection.md](./02-skill-injection.md)** - Add domain knowledge with skills
- **[03-tool-development.md](./03-tool-development.md)** - Build powerful tools with validation
- **[04-publishing.md](./04-publishing.md)** - Deploy your plugin to npm

## Reference

- **[@opencode-ai/plugin API](https://github.com/opencode-ai/opencode)** - Full plugin API reference
- **[Bun Build Docs](https://bun.sh/docs/bundler)** - Advanced build configuration
- **[TypeScript Handbook](https://www.typescriptlang.org/docs/)** - TypeScript deep dive

## Troubleshooting

**"Cannot find module '@opencode-ai/plugin'"**
```bash
bun install  # Run install to fetch peer dependency
```

**"Build fails with type errors"**
```bash
bun run typecheck  # Check TypeScript errors before build
```

**"Plugin not loading in OpenCode"**
- Verify `./plugin` export in package.json
- Check that only functions are exported from `src/plugin.ts`
- Ensure build ran successfully (`ls dist/`)
